name: Policy Check (OPA)

on:
  push:
  pull_request:

jobs:
  opa_policy_check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: 0.63.0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # ✅ IMPORTANT: only test .rego files (avoids broken JSON)
      - name: Run OPA policy tests
        run: opa test ./input/*.rego -v

      - name: Evaluate policy (allow + deny)
        run: |
          set -e

          # Approved input (should PASS)
          echo '{"image":"python:3.11-slim"}' > input.json

          echo "== OPA allow decision =="
          opa eval -f pretty -d ./input/policy.rego "data.cicd.image.allow" --input input.json

          echo "== OPA deny reasons (if any) =="
          DENY=$(opa eval -f json -d ./input/policy.rego "data.cicd.image.deny" --input input.json \
            | jq -r '.result[0].expressions[0].value[]?')

          if [ -n "$DENY" ]; then
            echo "::error::Policy violations detected:"
            echo "$DENY"
            exit 1
          else
            echo "✅ No policy violations."
          fi
