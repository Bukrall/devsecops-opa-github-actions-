name: Policy Check (OPA)

on:
  push:
  pull_request:

jobs:
  opa_policy_check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: 0.63.0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # Only test Rego files (so JSON files can't break test loading)
      - name: Run OPA policy tests
        run: opa test ./input/*.rego -v

      - name: Evaluate policy (create audit evidence)
        run: |
          set -e

          # Input used for evaluation
          echo '{"image":"python:3.11-slim"}' > input.json

          # Pre-create files so upload never fails due to missing files
          echo '{}' > opa-allow.json
          echo '{}' > opa-deny.json
          echo '{}' > opa-decision.json

          # Run OPA evaluations (never leave files missing)
          opa eval -f json -d ./input/policy.rego "data.cicd.image.allow" --input input.json > opa-allow.json || true
          opa eval -f json -d ./input/policy.rego "data.cicd.image.deny"  --input input.json > opa-deny.json  || true

          # Build combined audit JSON (safe even if allow/deny outputs are empty)
          jq -n \
            --arg workflow "${{ github.workflow }}" \
            --arg run_id "${{ github.run_id }}" \
            --arg sha "${{ github.sha }}" \
            --arg timestamp "$(date -u +%FT%TZ)" \
            --slurpfile allow opa-allow.json \
            --slurpfile deny opa-deny.json \
            '{
              workflow: $workflow,
              run_id: $run_id,
              sha: $sha,
              timestamp_utc: $timestamp,
              opa_allow_result: ($allow[0] // {}),
              opa_deny_result: ($deny[0] // {})
            }' > opa-decision.json

          echo "=== Debug: files created ==="
          ls -la opa-allow.json opa-deny.json opa-decision.json
          echo "=== Debug: opa-decision.json ==="
          cat opa-decision.json

          # Enforce: fail if deny contains any messages (handles null safely)
          DENY_LINES=$(jq -r '.result[0].expressions[0].value[]? // empty' opa-deny.json 2>/dev/null || true)

          if [ -n "$DENY_LINES" ]; then
            echo "::error::Policy violations detected:"
            echo "$DENY_LINES"
            exit 1
          else
            echo "âœ… No policy violations."
          fi

      - name: Upload OPA audit evidence
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: opa-audit-evidence
          if-no-files-found: warn
          path: |
            opa-decision.json
            opa-allow.json
            opa-deny.json
