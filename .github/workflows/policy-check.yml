name: Policy Check (OPA)

on:
  push:
  pull_request:

jobs:
  opa_policy_check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: latest

      - name: Run OPA policy tests
        run: opa test ./input -v

      - name: Evaluate policy (show deny reasons)
        run: |
          set -e

          # ✅ Good input (should pass)
          echo '{"image":"python:3.11-slim"}' > input.json
          echo "== Checking approved image =="
          opa eval -f pretty -d ./input/policy.rego "data.cicd.image.allow" --input input.json

          # ❌ Bad input (demo case) — uncomment if you WANT CI to fail on purpose
          # echo '{"image":"python:latest"}' > input.json

          echo "== Checking deny reasons (if any) =="
          DENY=$(opa eval -f json -d ./input/policy.rego "data.cicd.image.deny" --input input.json \
            | jq -r '.result[0].expressions[0].value[]?')

          if [ -n "$DENY" ]; then
            echo "::error::Policy violations detected:"
            echo "$DENY"
            exit 1
          else
            echo "✅ No policy violations."
          fi
