      - name: Evaluate policy (create audit evidence)
        run: |
          set -e

          echo '{"image":"python:3.11-slim"}' > input.json

          echo "== OPA allow decision =="
          opa eval -f json -d ./input/policy.rego "data.cicd.image.allow" --input input.json \
            | tee opa-allow.json

          echo "== OPA deny reasons (if any) =="
          opa eval -f json -d ./input/policy.rego "data.cicd.image.deny" --input input.json \
            | tee opa-deny.json

          jq -n \
            --arg workflow "${{ github.workflow }}" \
            --arg run_id "${{ github.run_id }}" \
            --arg sha "${{ github.sha }}" \
            --arg timestamp "$(date -u +%FT%TZ)" \
            --slurpfile allow opa-allow.json \
            --slurpfile deny opa-deny.json \
            '{
              workflow: $workflow,
              run_id: $run_id,
              sha: $sha,
              timestamp_utc: $timestamp,
              input: (input | fromjson? // {}),
              opa_allow_result: $allow[0],
              opa_deny_result: $deny[0]
            }' < input.json > opa-decision.json

          echo "== Audit evidence saved to opa-decision.json =="
          cat opa-decision.json

          DENY_LINES=$(jq -r '.result[0].expressions[0].value[]?' opa-deny.json)
          if [ -n "$DENY_LINES" ]; then
            echo "::error::Policy violations detected:"
            echo "$DENY_LINES"
            exit 1
          else
            echo "No policy violations."
          fi
